// src/hooks/useSmartPlanner.js (v3.1 - Fix Generación y Renderizado)
import { useState, useEffect, useCallback } from 'react';
import { recipes } from '../data/recipes';

const DAYS = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];
const MEAL_SLOTS = [
  { id: 'desayuno', label: 'Desayuno', types: ['Platillo Ligero'] },
  { id: 'comida', label: 'Comida', types: ['Platillo Principal'] },
  { id: 'cena', label: 'Cena', types: ['Platillo Ligero'] },
  { id: 'snack', label: 'Antojo', types: ['Antojo sin Culpa'] }
];

export function useSmartPlanner() {
  const [weekPlan, setWeekPlan] = useState({});
  const [activeTab, setActiveTab] = useState('rapido');
  const [version, setVersion] = useState(0); // Truco para forzar re-render

  // Helpers
  const getRecipesByType = (type) => recipes.filter(r => r.type === type);
  const getRandom = (arr) => arr.length > 0 ? arr[Math.floor(Math.random() * arr.length)] : null;

  const generateQuickMenu = useCallback(() => {
    const newPlan = {};
    const ligeros = getRecipesByType('Platillo Ligero');
    const fuertes = getRecipesByType('Platillo Principal');
    const antojos = getRecipesByType('Antojo sin Culpa');

    DAYS.forEach(day => {
      newPlan[day] = {
        desayuno: getRandom(ligeros),
        comida: getRandom(fuertes),
        cena: getRandom(ligeros),
        snack: Math.random() > 0.5 ? getRandom(antojos) : null
      };
    });

    setWeekPlan(newPlan);
    setVersion(v => v + 1); // Forzar actualización visual
  }, []);

  // Cargar al inicio
  useEffect(() => {
    const saved = localStorage.getItem('rm_smart_plan');
    if (saved) {
      try {
        setWeekPlan(JSON.parse(saved));
      } catch (e) {
        generateQuickMenu();
      }
    } else {
      generateQuickMenu();
    }
  }, []);

  // Guardar cambios
  useEffect(() => {
    if (Object.keys(weekPlan).length > 0) {
      localStorage.setItem('rm_smart_plan', JSON.stringify(weekPlan));
    }
  }, [weekPlan]);

  const updateSlot = (day, slotId, recipe) => {
    setWeekPlan(prev => ({
      ...prev,
      [day]: { ...prev[day], [slotId]: recipe }
    }));
  };

  const shuffleSlot = (day, slotId) => {
    const slotConfig = MEAL_SLOTS.find(s => s.id === slotId);
    if (!slotConfig) return;
    const candidates = recipes.filter(r => slotConfig.types.includes(r.type));
    const randomRecipe = getRandom(candidates);
    updateSlot(day, slotId, randomRecipe);
  };

  const calculateDailyStats = (day) => {
    const meals = weekPlan[day];
    if (!meals) return 0;
    let totalProtein = 0;
    MEAL_SLOTS.forEach(slot => {
      const recipe = meals[slot.id];
      if (recipe && recipe.proteina_aprox_g) {
        totalProtein += recipe.proteina_aprox_g;
      }
    });
    return Math.round(totalProtein);
  };

  return {
    weekPlan,
    generateQuickMenu,
    updateSlot,
    shuffleSlot,
    calculateDailyStats,
    activeTab,
    setActiveTab,
    days: DAYS,
    slots: MEAL_SLOTS,
    version // Exportamos esto para usarlo como key
  };
}